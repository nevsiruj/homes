name: Deploy Media Naranja - CRM

on:
  workflow_dispatch:
    inputs:
      deploy_target:
        description: 'Component to deploy'
        required: true
        default: 'crm'
        type: choice
        options:
          - crm
          - api
          - web
          - all

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      if: ${{ github.event.inputs.deploy_target == 'crm' || github.event.inputs.deploy_target == 'web' || github.event.inputs.deploy_target == 'all' }}
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Setup .NET
      if: ${{ github.event.inputs.deploy_target == 'api' || github.event.inputs.deploy_target == 'all' }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '6.0.x'
        
    - name: Verify environment
      run: |
        Write-Host "Current directory: $PWD"
        if ("${{ github.event.inputs.deploy_target }}" -eq "crm" -or "${{ github.event.inputs.deploy_target }}" -eq "web" -or "${{ github.event.inputs.deploy_target }}" -eq "all") {
          Write-Host "Node version: $(node --version)"
          Write-Host "NPM version: $(npm --version)"
        }
        if ("${{ github.event.inputs.deploy_target }}" -eq "api" -or "${{ github.event.inputs.deploy_target }}" -eq "all") {
          Write-Host "Dotnet version: $(dotnet --version)"
        }
      shell: powershell
        
    - name: Deploy to Media Naranja
      run: |
        $scriptPath = "$env:GITHUB_WORKSPACE\.agent\workflows\deploy-medianaranja.ps1"
        
        switch ("${{ github.event.inputs.deploy_target }}") {
          "crm" { & $scriptPath -RepoPath "$env:GITHUB_WORKSPACE" -DeployCRM }
          "api" { & $scriptPath -RepoPath "$env:GITHUB_WORKSPACE" -DeployAPI }
          "web" { & $scriptPath -RepoPath "$env:GITHUB_WORKSPACE" -DeployWeb }
          "all" { & $scriptPath -RepoPath "$env:GITHUB_WORKSPACE" -All }
        }
      shell: powershell
      
    - name: Show deployment logs
      if: always()
      run: |
        $latestLog = Get-ChildItem "C:\DeployScripts\logs\deploy-medianaranja-*.log" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
        if ($latestLog) {
          Write-Host "=== Deployment Log ==="
          Get-Content $latestLog.FullName
        }
      shell: powershell
      
    - name: Deployment Success
      if: success()
      run: Write-Host "Media Naranja deployment completed successfully!"
      shell: powershell
      
    - name: Deployment Failed
      if: failure()
      run: Write-Host "Media Naranja deployment failed! Check logs above."
      shell: powershell
